name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  json-lint:
    name: JSON Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate JSON formatting
        run: |
          python3 bin/format_user_domains.py
          if ! git diff --quiet data/user_domains.json; then
            echo "ERROR: data/user_domains.json is not properly formatted"
            echo "Run: python3 bin/format_user_domains.py"
            git diff data/user_domains.json
            exit 1
          fi

  test-nodejs:
    name: Node.js Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Copy data files and run tests
        run: |
          cp data/*.json libraries/nodejs/
          cd libraries/nodejs/
          npm install
          npm test

  test-python:
    name: Python Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install dependencies
        run: pip install -r requirements-dev.txt

      - name: Run tests
        run: |
          cd bin
          python -m pytest test_crawl_localgov.py -v

      - name: Lint with ruff
        run: |
          pip install ruff
          ruff check bin/

  build-nodejs:
    name: Build Node.js Package
    runs-on: ubuntu-latest
    needs: [json-lint, test-nodejs]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Build package
        run: |
          cp data/*.json libraries/nodejs/
          cd libraries/nodejs/
          npm install
          npm run sync-version
          npm pack
          echo "Package built successfully:"
          ls -la *.tgz

  build-python:
    name: Build Python Package
    runs-on: ubuntu-latest
    needs: [json-lint, test-python]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Build package
        run: |
          cp data/*.json libraries/python/src/
          cd libraries/python/
          pip install build
          python -m build
          echo "Package built successfully:"
          ls -la dist/
